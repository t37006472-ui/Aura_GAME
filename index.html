<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA: Metroidvania</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; touch-action: none; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>

<script>
// ==========================================
// 1. GERENCIADORES
// ==========================================
const SaveManager = {
    saveKey: 'AuraGameSave',
    save: (data) => localStorage.setItem('AuraGameSave', JSON.stringify(data)),
    load: () => JSON.parse(localStorage.getItem('AuraGameSave')),
    clear: () => localStorage.removeItem('AuraGameSave')
};

// ==========================================
// 2. CENA DE TÍTULO (VERSÃO ULTRA-ROBUSTA)
// ==========================================
class TitleScene extends Phaser.Scene {
    constructor() { super('TitleScene'); }
    create() {
        const { width, height } = this.scale;
        
        this.add.text(width/2, height/3, 'AURA', { 
            fontSize: '80px', fill: '#00ffcc', fontStyle: 'bold' 
        }).setOrigin(0.5);
        
        // 1. Criar um retângulo invisível gigante para o botão
        const hitArea = this.add.rectangle(width/2, height/1.8, 300, 100, 0xffffff, 0.01)
            .setInteractive({ useHandCursor: true });

        const startText = this.add.text(width/2, height/1.8, 'NOVO JOGO', { 
            fontSize: '42px', fill: '#fff'
        }).setOrigin(0.5);

        // 2. Tentar iniciar no pointerup (mais estável no mobile)
        hitArea.on('pointerup', () => this.startGame());

        // 3. Backup: Se clicar em qualquer lado da tela, tenta iniciar
        this.input.once('pointerdown', () => {
            console.log("Toque global detetado");
            this.startGame();
        });

        const savedData = SaveManager.load();
        if (savedData) {
            this.add.text(width/2, height/1.4, 'CONTINUAR', { 
                fontSize: '32px', fill: '#ffff00' 
            }).setOrigin(0.5).setInteractive().on('pointerup', () => {
                this.scene.start('MainScene', savedData);
            });
        }
    }

    startGame() {
        if (this.started) return;
        this.started = true;
        console.log("A iniciar MainScene...");
        SaveManager.clear();
        this.scene.start('MainScene', { hp: 5, abilities: { doubleJump: true } });
    }
}

// ==========================================
// 3. CENA PRINCIPAL (IA DO BOSS E JOGO)
// ==========================================

class FinalBoss extends Phaser.Physics.Arcade.Sprite {
    constructor(scene, x, y) {
        super(scene, x, y, null);
        scene.add.existing(this);
        scene.physics.add.existing(this);
        this.display = scene.add.rectangle(0, 0, 80, 120, 0x9900ff).setParentContainer(this);
        this.hp = 15;
        this.body.setAllowGravity(false).setImmovable(true);
        this.startAI();
    }
    startAI() {
        this.scene.time.addEvent({
            delay: 2000,
            callback: () => {
                if (!this.active || this.hp <= 0) return;
                const r = Phaser.Math.Between(0, 2);
                if (r === 0) this.dash(); else if (r === 1) this.shoot(); else this.teleport();
            },
            loop: true
        });
    }
    dash() {
        if(!this.active) return;
        this.display.setFillStyle(0xff0000);
        this.scene.time.delayedCall(500, () => {
            if (!this.active) return;
            this.scene.physics.moveToObject(this, this.scene.player, 600);
            this.scene.time.delayedCall(800, () => { if(this.active) this.setVelocity(0); this.display.setFillStyle(0x9900ff); });
        });
    }
    shoot() {
        for (let i = 0; i < 5; i++) {
            let b = this.scene.bossBullets.get(this.x, this.y);
            if (b) {
                b.setActive(true).setVisible(true).body.setAllowGravity(false);
                this.scene.physics.velocityFromAngle(-180 + (i * 45), 300, b.body.velocity);
            }
        }
    }
    teleport() {
        this.scene.tweens.add({ targets: this, alpha: 0, duration: 200, onComplete: () => {
            this.x = Phaser.Math.Between(1500, 1900); this.y = Phaser.Math.Between(100, 400); this.alpha = 1;
        }});
    }
    takeDamage() {
        this.hp--;
        this.display.setFillStyle(0xffffff);
        this.scene.time.delayedCall(100, () => this.display.setFillStyle(0x9900ff));
        if (this.hp <= 0) { this.scene.celebrateVictory(); this.destroy(); }
    }
}

class MainScene extends Phaser.Scene {
    constructor() { super('MainScene'); }
    init(data) {
        this.hp = data.hp || 5;
        this.abilities = data.abilities || { doubleJump: true };
        this.moveVal = 0;
    }
    create() {
        const worldWidth = 2000;
        this.physics.world.setBounds(0, 0, worldWidth, 600);
        this.platforms = this.physics.add.staticGroup();
        this.platforms.add(this.add.rectangle(1000, 580, worldWidth, 40, 0x333333));
        this.platforms.add(this.add.rectangle(400, 450, 200, 20, 0x555555));

        this.player = this.physics.add.sprite(100, 500, null);
        this.player.body.setSize(32, 48);
        this.add.rectangle(0, 0, 32, 48, 0x00ff00).setParentContainer(this.player);
        this.physics.add.collider(this.player, this.platforms);

        this.bossBullets = this.physics.add.group();
        this.boss = new FinalBoss(this, 1800, 300);
        this.attackZone = this.add.rectangle(0, 0, 70, 50, 0xffff00, 0);
        this.physics.add.existing(this.attackZone);
        this.attackZone.body.setAllowGravity(false).setEnable(false);

        this.physics.add.overlap(this.attackZone, this.boss, (z, b) => b.takeDamage());
        this.physics.add.overlap(this.player, this.bossBullets, (p, b) => { b.destroy(); this.hp--; });

        this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
        this.cameras.main.setBounds(0, 0, worldWidth, 600);

        this.createMobileUI();
    }
    createMobileUI() {
        this.input.addPointer(2);
        const { width, height } = this.scale;
        const jX = 120, jY = height - 100;
        this.joyThumb = this.add.circle(jX, jY, 25, 0xffffff, 0.3).setScrollFactor(0);
        this.add.circle(jX, jY, 50, 0xffffff, 0.1).setScrollFactor(0);

        const btnJump = this.add.circle(width - 100, height - 100, 50, 0x00ff00, 0.2).setScrollFactor(0).setInteractive();
        const btnAtk = this.add.circle(width - 220, height - 100, 50, 0xff0000, 0.2).setScrollFactor(0).setInteractive();

        btnJump.on('pointerdown', () => { if(this.player.body.onFloor()) this.player.setVelocityY(-450); });
        btnAtk.on('pointerdown', () => {
            this.attackZone.setPosition(this.player.x + (this.player.flipX ? -45 : 45), this.player.y);
            this.attackZone.body.setEnable(true);
            this.time.delayedCall(150, () => this.attackZone.body.setEnable(false));
        });

        this.input.on('pointermove', (p) => {
            if (p.isDown && p.x < 400) {
                let dist = Phaser.Math.Clamp(p.x - jX, -50, 50);
                this.joyThumb.x = jX + dist; this.moveVal = dist / 50;
            }
        });
        this.input.on('pointerup', (p) => { if(p.x < 400) { this.joyThumb.x = jX; this.moveVal = 0; } });
    }
    celebrateVictory() {
        this.add.text(this.player.x, 200, 'VITÓRIA!', { fontSize: '64px', fill: '#0f0' }).setOrigin(0.5);
        this.time.delayedCall(3000, () => location.reload());
    }
    update() {
        this.player.setVelocityX(this.moveVal * 250);
        if (this.moveVal !== 0) this.player.setFlipX(this.moveVal < 0);
    }
}

// ==========================================
// 4. CONFIGURAÇÃO
// ==========================================
const config = {
    type: Phaser.AUTO,
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 800, height: 450 },
    physics: { default: 'arcade', arcade: { gravity: { y: 1000 } } },
    scene: [TitleScene, MainScene]
};
const game = new Phaser.Game(config);
</script>
</body>
</html>
